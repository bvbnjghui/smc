<!-- smc/components/simulation-settings-modal.html -->
<div x-show="isSimulationSettingsModalOpen" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" x-transition>
    <div @click.outside="isSimulationSettingsModalOpen = false" class="bg-gray-800 rounded-2xl shadow-lg w-full max-w-md max-h-[90vh] flex flex-col p-6" x-show="isSimulationSettingsModalOpen" x-transition.scale>
        <div class="flex justify-between items-center mb-6 flex-shrink-0">
            <h2 class="text-2xl font-bold text-indigo-400">策略回測設定</h2>
            <button @click="isSimulationSettingsModalOpen = false" class="p-1 rounded-full hover:bg-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="overflow-y-auto space-y-4 pr-2">
            <!-- HTF 偏好設定 -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <label for="htfBias" class="text-sm text-gray-400">HTF 偏好 (Bias):</label>
                    <div x-data="{ tooltipVisible: false }" @mouseenter="tooltipVisible = true" @mouseleave="tooltipVisible = false" class="relative">
                        <button x-ref="infoBtnBias" type="button" class="text-gray-500 hover:text-gray-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div x-show="tooltipVisible" x-anchor.top.offset.8="$refs.infoBtnBias" x-transition class="absolute w-64 bg-gray-900 text-gray-200 text-xs rounded-lg p-2 shadow-lg z-10 pointer-events-none">
                            設定高時間週期的主要交易方向。模擬器將只尋找符合此偏好的交易機會。
                        </div>
                    </div>
                </div>
                <select id="htfBias" x-model="htfBias" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-50">
                    <option value="both">多空皆可 (Both)</option>
                    <option value="long_only">僅做多 (Long Only)</option>
                    <option value="short_only">僅做空 (Short Only)</option>
                </select>
            </div>

            <!-- 進場策略選擇 -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <label for="entryStrategy" class="text-sm text-gray-400">進場策略 (Entry Strategy):</label>
                    <div x-data="{ tooltipVisible: false }" @mouseenter="tooltipVisible = true" @mouseleave="tooltipVisible = false" class="relative">
                        <button x-ref="infoBtnStrategy" type="button" class="text-gray-500 hover:text-gray-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div x-show="tooltipVisible" x-anchor.top.offset.8="$refs.infoBtnStrategy" x-transition class="absolute w-64 bg-gray-900 text-gray-200 text-xs rounded-lg p-2 shadow-lg z-10 pointer-events-none">
                            選擇回測時使用的進場邏輯。<br><b>反轉確認型:</b> 等待 CHoCH 信號出現後再進場。<br><b>區域反應型:</b> 直接在符合趨勢的 POI (OB/FVG) 處進場，不等待確認。
                        </div>
                    </div>
                </div>
                <select id="entryStrategy" x-model="entryStrategy" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-50">
                    <option value="reversal_confirmation">反轉確認型 (Confirmation)</option>
                    <option value="poi_reaction">區域反應型 (Risk Entry)</option>
                </select>
            </div>

            <!-- 權重計分系統設定 -->
            <div x-show="entryStrategy === 'poi_reaction'" x-collapse class="space-y-4 pt-4 border-t border-gray-600">
                <h3 class="text-lg font-semibold text-gray-300">權重計分設定</h3>
                <div class="space-y-2">
                    <label class="text-sm text-gray-400">進場權重門檻:</label>
                    <input type="number" x-model.number="entryScoreThreshold" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400">OB 權重:</label>
                        <input type="number" x-model.number="obWeight" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400">Breaker 權重:</label>
                        <input type="number" x-model.number="breakerWeight" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400">MTA 權重:</label>
                        <input type="number" x-model.number="mtaWeight" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400">EMA 權重:</label>
                        <input type="number" x-model.number="emaWeight" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                    </div>
                </div>
                 <div class="space-y-2">
                    <label class="text-sm text-gray-400">近期流動性掠奪權重:</label>
                    <input type="number" x-model.number="liquidityGrabWeight" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                </div>
                <div class="space-y-2">
                    <label class="text-sm text-gray-400">誘導性流動性掠奪權重:</label>
                    <input type="number" x-model.number="inducementWeight" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                </div>
            </div>

            <!-- 初始金額 -->
            <div class="space-y-2 pt-4 border-t border-gray-600">
                <div class="flex items-center space-x-2">
                    <label for="investmentAmount" class="text-sm text-gray-400">初始金額 ($):</label>
                    <div x-data="{ tooltipVisible: false }" @mouseenter="tooltipVisible = true" @mouseleave="tooltipVisible = false" class="relative">
                        <button x-ref="infoBtnAmount" type="button" class="text-gray-500 hover:text-gray-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div x-show="tooltipVisible" x-anchor.top.offset.8="$refs.infoBtnAmount" x-transition class="absolute w-64 bg-gray-900 text-gray-200 text-xs rounded-lg p-2 shadow-lg z-10 pointer-events-none">
                            這是您開始回測時的初始模擬資金總額。
                        </div>
                    </div>
                </div>
                <input type="number" id="investmentAmount" x-model.number="investmentAmount" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-50">
            </div>
            <!-- 單一訊號風險 -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <label for="riskPerTrade" class="text-sm text-gray-400">單筆風險 (%):</label>
                    <div x-data="{ tooltipVisible: false }" @mouseenter="tooltipVisible = true" @mouseleave="tooltipVisible = false" class="relative">
                        <button x-ref="infoBtnRisk" type="button" class="text-gray-500 hover:text-gray-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div x-show="tooltipVisible" x-anchor.top.offset.8="$refs.infoBtnRisk" x-transition class="absolute w-64 bg-gray-900 text-gray-200 text-xs rounded-lg p-2 shadow-lg z-10 pointer-events-none">
                            您願意為每一筆交易承擔的資金風險百分比。例如：1% 代表單筆交易最多虧損當前帳戶權益的 1%。
                        </div>
                    </div>
                </div>
                <input type="number" id="riskPerTrade" x-model.number="riskPerTrade" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-50">
            </div>
            <!-- 風險回報比 -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <label for="rrRatio" class="text-sm text-gray-400">第一止盈點 (TP1) 風險回報比:</label>
                </div>
                <input type="number" id="rrRatio" x-model.number="rrRatio" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-50">
            </div>
            
            <!-- 第二止盈點與保本止損 -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <label for="rrRatioTP2" class="text-sm text-gray-400">第二止盈點 (TP2) 風險回報比:</label>
                    <div x-data="{ tooltipVisible: false }" @mouseenter="tooltipVisible = true" @mouseleave="tooltipVisible = false" class="relative">
                        <button x-ref="infoBtnTp2" type="button" class="text-gray-500 hover:text-gray-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div x-show="tooltipVisible" x-anchor.top.offset.8="$refs.infoBtnTp2" x-transition class="absolute w-64 bg-gray-900 text-gray-200 text-xs rounded-lg p-2 shadow-lg z-10 pointer-events-none">
                            設定剩餘一半倉位的最終止盈目標。必須大於 TP1。
                        </div>
                    </div>
                </div>
                <input type="number" id="rrRatioTP2" x-model.number="rrRatioTP2" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-50">
            </div>
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="enableBreakeven" x-model="enableBreakeven" class="w-4 h-4 text-teal-600 bg-gray-700 border-gray-600 rounded focus:ring-teal-500">
                <label for="enableBreakeven" class="text-sm text-gray-300">觸發 TP1 後啟用保本止損</label>
                 <div x-data="{ tooltipVisible: false }" @mouseenter="tooltipVisible = true" @mouseleave="tooltipVisible = false" class="relative">
                    <button x-ref="infoBtnBe" type="button" class="text-gray-500 hover:text-gray-300">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div x-show="tooltipVisible" x-anchor.top.offset.8="$refs.infoBtnBe" x-transition class="absolute w-64 bg-gray-900 text-gray-200 text-xs rounded-lg p-2 shadow-lg z-10 pointer-events-none">
                        勾選後，當價格觸及 TP1，剩餘倉位的止損點將自動移動到您的進場成本價，成為一筆「零風險」的交易。
                    </div>
                </div>
            </div>
            
            <!-- 等待 K 棒數量 -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <label for="setupExpirationCandles" class="text-sm text-gray-400">等待 K 棒數量:</label>
                    <div x-data="{ tooltipVisible: false }" @mouseenter="tooltipVisible = true" @mouseleave="tooltipVisible = false" class="relative">
                        <button x-ref="infoBtnExp" type="button" class="text-gray-500 hover:text-gray-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div x-show="tooltipVisible" x-anchor.top.offset.8="$refs.infoBtnExp" x-transition class="absolute w-64 bg-gray-900 text-gray-200 text-xs rounded-lg p-2 shadow-lg z-10 pointer-events-none">
                            在一個有效的交易設定 (Setup) 形成後，模擬器會等待幾根 K 棒的時間讓價格回到進場區。如果超過這個數量價格仍未進場，該設定將會失效。
                        </div>
                    </div>
                </div>
                <input type="number" id="setupExpirationCandles" x-model.number="setupExpirationCandles" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-50">
            </div>
        </div>
        <div class="mt-6 flex-shrink-0">
            <button @click="runSimulationFromModal()" :disabled="isSimulating" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                <span x-show="!isSimulating">執行策略模擬</span>
                <span x-show="isSimulating">模擬中...</span>
            </button>
        </div>
    </div>
</div>
