# 參數優化功能設計文檔

## 概述
增強回測模擬系統，增加參數優化功能，讓用戶能夠系統性地調整參數並找出最高勝率與收益率的組合。

## 現有參數結構分析

### 權重參數 (影響進場決策)
- `obWeight`: 訂單塊權重 (預設: 2)
- `breakerWeight`: 突破塊權重 (預設: 2)
- `mtaWeight`: 多時間週期權重 (預設: 2)
- `emaWeight`: EMA趨勢權重 (預設: 1)
- `liquidityGrabWeight`: 流動性掠奪權重 (預設: 1)
- `inducementWeight`: 誘導權重 (預設: 3)

### 閾值參數
- `entryScoreThreshold`: 進場分數閾值 (預設: 3)

### 技術指標參數
- `emaPeriod`: EMA週期 (預設: 50)
- `atrPeriod`: ATR週期 (預設: 14)
- `atrMultiplier`: ATR止損乘數 (預設: 2)

### 風險管理參數
- `riskPerTrade`: 單筆交易風險% (預設: 1)
- `rrRatio`: 第一止盈盈虧比 (預設: 2)
- `rrRatioTP2`: 第二止盈盈虧比 (預設: 3)

### 其他參數
- `recentLiquidityGrabLookback`: 流動性掠奪回溯期間 (預設: 20)
- `setupExpirationCandles`: 設定過期K棒數 (預設: 30)

## 優化策略設計

### 階段1: 參數分組優化
將參數分為幾個邏輯群組，逐步優化：

1. **權重參數群組**
   - obWeight, breakerWeight, mtaWeight, emaWeight, liquidityGrabWeight, inducementWeight
   - 優化目標: 最大化勝率

2. **技術指標參數群組**
   - emaPeriod, atrPeriod, atrMultiplier
   - 優化目標: 最大化夏普比率

3. **風險管理參數群組**
   - riskPerTrade, rrRatio, rrRatioTP2
   - 優化目標: 最大化凈收益

### 階段2: 組合優化
在各群組找到最佳參數後，進行跨群組的組合優化。

## 優化算法

### 網格搜索 (Grid Search)
- 系統性測試所有參數組合
- 適用於參數數量不多的情況
- 計算複雜度: O(n^k) 其中 n 為參數值數量，k 為參數個數

### 隨機搜索 (Random Search)
- 在參數空間中隨機取樣
- 更有效率地探索參數空間
- 適合高維參數空間

### 遺傳算法 (Genetic Algorithm)
- 模擬自然選擇過程
- 適合複雜的非線性優化問題
- 可以找到全域性最優解

## 實現架構

### 核心模組
```
modules/
├── parameter-optimizer.js      # 主要優化引擎
├── optimization-config.js      # 參數範圍配置
├── optimization-results.js     # 結果處理與分析
└── optimization-ui.js          # UI 整合
```

### 優化流程
1. 用戶選擇要優化的參數
2. 設定參數範圍和步長
3. 選擇優化目標 (勝率/收益率/夏普比率)
4. 執行優化過程
5. 顯示結果和建議

## UI 設計

### 參數優化設定面板
- 參數選擇勾選框
- 範圍設定 (最小值/最大值/步長)
- 優化目標選擇
- 優化算法選擇

### 進度顯示
- 實時進度條
- 當前測試的參數組合
- 預估剩餘時間

### 結果視覺化
- 熱力圖顯示參數組合的表現
- 散點圖顯示勝率vs收益率
- 最佳參數組合詳情
- 參數敏感度分析

## 效能考量

### 計算優化
- 使用 Web Workers 進行並行計算
- 實現中斷機制讓用戶可以停止優化
- 快取已計算的結果避免重複計算

### 記憶體管理
- 分批處理大量參數組合
- 及時清理不需要的數據
- 使用高效的數據結構

## 風險控制

### 過度擬合防範
- 交叉驗證
- 樣本外測試
- 參數穩定性檢查

### 計算資源限制
- 設定最大迭代次數
- 時間限制
- 記憶體使用監控

## 未來擴展

### 進階優化算法
- 貝葉斯優化
- 梯度下降方法
- 強化學習

### 多目標優化
- 同時優化勝率和收益率
- 使用帕累托前沿分析

### 機器學習整合
- 使用歷史數據訓練參數預測模型
- 動態參數調整