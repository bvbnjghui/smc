<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMC 策略分析儀</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TradingView Lightweight Charts CDN -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Alpine.js CDN for interactivity -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chart {
            height: 600px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-8">

    <div class="max-w-7xl mx-auto" x-data="app()">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-teal-400 mb-2">SMC 策略分析儀</h1>
            <p class="text-lg text-gray-400">即時分析虛擬貨幣市場的價格與流動性</p>
        </header>

        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <div class="flex flex-wrap items-center justify-center space-y-4 md:space-y-0 md:space-x-6">
                <div class="flex items-center space-x-2">
                    <label for="symbol" class="text-gray-400">交易對:</label>
                    <input type="text" id="symbol" x-model="symbol" class="p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-teal-500 w-32 text-gray-50 uppercase">
                </div>
                <div class="flex items-center space-x-2">
                    <label for="interval" class="text-gray-400">週期:</label>
                    <select id="interval" x-model="interval" class="p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-50">
                        <template x-for="option in intervals">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
                <button @click="fetchData" :disabled="isLoading" class="bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-teal-700 transition duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!isLoading">載入數據</span>
                    <span x-show="isLoading">載入中...</span>
                </button>
            </div>
        </div>

        <div id="chart" class="bg-gray-800 rounded-2xl shadow-lg"></div>

        <div x-show="error" class="bg-red-900 text-red-200 p-4 rounded-xl mt-8 text-center" x-text="error"></div>
    </div>

    <script>
        function app() {
            return {
                // 請確保您的 API URL 是正確的
                apiUrl: 'https://smc-338857749184.europe-west1.run.app/api/klines',
                symbol: 'BTCUSDT',
                interval: '15m',
                intervals: [
                    { value: '1m', label: '1 分鐘' },
                    { value: '5m', label: '5 分鐘' },
                    { value: '15m', label: '15 分鐘' },
                    { value: '1h', label: '1 小時' },
                    { value: '4h', label: '4 小時' },
                    { value: '1d', label: '1 日' },
                ],
                isLoading: false,
                error: '',
                chart: null,
                candleSeries: null,
                volumeSeries: null,

                init() {
                    this.$nextTick(() => {
                        this.setupChart();
                        if (this.chart) {
                            this.fetchData();
                        }
                    });
                },

                setupChart() {
                    const container = document.getElementById('chart');
                    if (!container) {
                        console.error("找不到 ID 為 'chart' 的元素");
                        return;
                    }
                    this.chart = LightweightCharts.createChart(container, {
                        layout: {
                            background: { color: '#1f2937' },
                            textColor: '#d1d5db',
                        },
                        grid: {
                            vertLines: { color: '#374151' },
                            horzLines: { color: '#374151' },
                        },
                        // ** 新增：啟用圖表縮放與平移 **
                        handleScroll: {
                            mouseWheel: true,
                        },
                        handleScale: {
                            axisPressedMouseMove: true,
                            mouseWheel: true,
                            pinch: true,
                        },
                        // ** 新增：設定價格軸的邊界 **
                        rightPriceScale: {
                            borderColor: '#4b5563',
                            scaleMargins: {
                                top: 0.3, // 頂部留 30% 空間
                                bottom: 0.25, // 底部留 25% 空間
                            },
                        },
                        // ** 新增：設定時間軸的邊界與捲動 **
                        timeScale: {
                            borderColor: '#4b5563',
                            rightOffset: 12, // 右側留 12 根 K 棒的空間
                            timeVisible: true,
                        },
                    });

                    this.candleSeries = this.chart.addSeries(LightweightCharts.CandlestickSeries, {
                        upColor: '#10b981',
                        downColor: '#ef4444',
                        borderUpColor: '#10b981',
                        borderDownColor: '#ef4444',
                        wickUpColor: '#10b981',
                        wickDownColor: '#ef4444',
                    });

                    // ** 修改：將交易量圖表放在獨立的窗格中 **
                    this.volumeSeries = this.chart.addSeries(LightweightCharts.HistogramSeries, {
                        color: '#26a69a',
                        priceFormat: {
                            type: 'volume',
                        },
                        // 設置為空字串會創建一個新的價格軸窗格
                        priceScaleId: '', 
                        scaleMargins: {
                            top: 0.8, // 頂部留 80% 空間
                            bottom: 0,
                        },
                    });

                    // 自動調整大小
                    new ResizeObserver(entries => {
                        if (entries.length === 0 || entries[0].target.offsetHeight === 0) {
                            return;
                        }
                        const { width, height } = entries[0].contentRect;
                        this.chart.applyOptions({ width, height });
                    }).observe(container);
                },

                async fetchData() {
                    if (!this.candleSeries || !this.volumeSeries) {
                        this.error = '圖表尚未初始化，無法載入數據。';
                        console.error('Chart is not initialized, cannot fetch data.');
                        return;
                    }

                    this.isLoading = true;
                    this.error = '';
                    try {
                        const response = await fetch(`${this.apiUrl}?symbol=${this.symbol}&interval=${this.interval}`);
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`API 請求失敗，狀態碼: ${response.status}. 回應: ${errorText}`);
                        }
                        const rawData = await response.json();
                        
                        const candles = rawData.map(d => ({
                            time: d[0] / 1000,
                            open: parseFloat(d[1]),
                            high: parseFloat(d[2]),
                            low: parseFloat(d[3]),
                            close: parseFloat(d[4]),
                        }));
                        
                        // ** 修改：讓交易量顏色更美觀 (半透明) **
                        const volumes = rawData.map(d => ({
                            time: d[0] / 1000,
                            value: parseFloat(d[5]),
                            color: parseFloat(d[4]) >= parseFloat(d[1]) ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)',
                        }));

                        this.candleSeries.setData(candles);
                        this.volumeSeries.setData(volumes);

                        // ** 新增：載入數據後，自動調整圖表視野以符合內容 **
                        this.chart.timeScale().fitContent();

                    } catch (e) {
                        this.error = `載入數據失敗: ${e.message}`;
                        console.error(e);
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        }
    </script>

</body>
</html>
